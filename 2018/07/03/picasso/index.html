<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>Picasso 源码学习 | 柘个角落 | IF YOU WANT SOMETHING, GO GET IT. PERIOD.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Android,源码学习">
    <meta name="description" content="Picasso 是由 Square 发布的图片加载框架，优雅地实现了 Android 系统中图片加载的功能。其中请求分类、任务调度、多级缓存等思想很有借鉴意义，本文将从源码角度阐述 Picasso 的工作原理。  Ask Yourself：实现一个图片加载框架图片的加载流程是获取 - 变换 - 显示，来源可能是网络、资源文件、本地文件，其中还要加上缓存，综上，可以整理出这样的流程图。">
<meta name="keywords" content="Android,源码学习">
<meta property="og:type" content="article">
<meta property="og:title" content="Picasso 源码学习">
<meta property="og:url" content="https://lilei.pro/2018/07/03/picasso/index.html">
<meta property="og:site_name" content="柘个角落">
<meta property="og:description" content="Picasso 是由 Square 发布的图片加载框架，优雅地实现了 Android 系统中图片加载的功能。其中请求分类、任务调度、多级缓存等思想很有借鉴意义，本文将从源码角度阐述 Picasso 的工作原理。  Ask Yourself：实现一个图片加载框架图片的加载流程是获取 - 变换 - 显示，来源可能是网络、资源文件、本地文件，其中还要加上缓存，综上，可以整理出这样的流程图。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://lilei.pro/img/180703_picasso/picasso_flowchart.png">
<meta property="og:image" content="https://lilei.pro/img/180703_picasso/picasso_classes_relation.png">
<meta property="og:updated_time" content="2018-07-06T07:37:50.118Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Picasso 源码学习">
<meta name="twitter:description" content="Picasso 是由 Square 发布的图片加载框架，优雅地实现了 Android 系统中图片加载的功能。其中请求分类、任务调度、多级缓存等思想很有借鉴意义，本文将从源码角度阐述 Picasso 的工作原理。  Ask Yourself：实现一个图片加载框架图片的加载流程是获取 - 变换 - 显示，来源可能是网络、资源文件、本地文件，其中还要加上缓存，综上，可以整理出这样的流程图。">
<meta name="twitter:image" content="https://lilei.pro/img/180703_picasso/picasso_flowchart.png">
    
        <link rel="alternate" type="application/atom+xml" title="柘个角落" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Li Lei</h5>
          <a href="mailto:bequietlee#gmail.com" title="bequietlee#gmail.com" class="mail">bequietlee#gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/bequietlee" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/2019/03/10/links"  >
                <i class="icon icon-lg icon-link"></i>
                友情链接
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Picasso 源码学习</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Picasso 源码学习</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-07-03T09:19:20.000Z" itemprop="datePublished" class="page-time">
  2018-07-03
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Ask-Yourself：实现一个图片加载框架"><span class="post-toc-number">1.</span> <span class="post-toc-text">Ask Yourself：实现一个图片加载框架</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#请求信息类-Request-RequestCreator"><span class="post-toc-number">2.</span> <span class="post-toc-text">请求信息类 Request/RequestCreator</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#缓存管理-LruCache"><span class="post-toc-number">3.</span> <span class="post-toc-text">缓存管理 LruCache</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#请求处理器-RequestHandler"><span class="post-toc-number">4.</span> <span class="post-toc-text">请求处理器 RequestHandler</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#任务调度器-Dispatcher"><span class="post-toc-number">5.</span> <span class="post-toc-text">任务调度器 Dispatcher</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#职责重大的-BitmapHunter"><span class="post-toc-number">6.</span> <span class="post-toc-text">职责重大的 BitmapHunter</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#碎碎念"><span class="post-toc-number">7.</span> <span class="post-toc-text">碎碎念</span></a></li></ol>
        </nav>
    </aside>


<article id="post-picasso"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Picasso 源码学习</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-07-03 17:19:20" datetime="2018-07-03T09:19:20.000Z"  itemprop="datePublished">2018-07-03</time>

            


            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <blockquote>
<p>Picasso 是由 Square 发布的图片加载框架，优雅地实现了 Android 系统中图片加载的功能。其中请求分类、任务调度、多级缓存等思想很有借鉴意义，本文将从源码角度阐述 Picasso 的工作原理。</p>
</blockquote>
<h1 id="Ask-Yourself：实现一个图片加载框架"><a href="#Ask-Yourself：实现一个图片加载框架" class="headerlink" title="Ask Yourself：实现一个图片加载框架"></a>Ask Yourself：实现一个图片加载框架</h1><p>图片的加载流程是<code>获取</code> - <code>变换</code> - <code>显示</code>，来源可能是网络、资源文件、本地文件，其中还要加上缓存，综上，可以整理出这样的流程图。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/img/180703_picasso/picasso_flowchart.png" alt="流程图" title="">
                </div>
                <div class="image-caption">流程图</div>
            </figure>
<p>结合上图，整理出主要职责类：</p>
<ul>
<li>请求包装类，包含请求地址、缓存策略</li>
<li>缓存类，内存+磁盘，两级缓存管理</li>
<li>请求处理类，实现相同的接口，有网络、本地、资源三种实现</li>
<li>下载器类，兼有暂停、恢复、取消功能</li>
<li>图片变换类，获取完图片后进行裁剪、缩放、旋转、圆角等变换</li>
<li>调度器类，管理线程</li>
</ul>
<p>有了自己的理解之后，再结合 Picasso 的代码进行学习。</p>
<h1 id="请求信息类-Request-RequestCreator"><a href="#请求信息类-Request-RequestCreator" class="headerlink" title="请求信息类 Request/RequestCreator"></a>请求信息类 Request/RequestCreator</h1><p>首先是 Request.java，这个类包含了待显示图片的地址、尺寸、缩放、旋转、裁剪信息，采用 Builder 模式，属性如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Uri uri;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> resourceId;</span><br><span class="line">	<span class="keyword">private</span> String stableKey;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> targetWidth;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> targetHeight;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> centerCrop;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> centerInside;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> onlyScaleDown;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> rotationDegrees;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> rotationPivotX;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">float</span> rotationPivotY;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> hasRotationPivot;</span><br><span class="line">	<span class="keyword">private</span> List&lt;Transformation&gt; transformations;</span><br><span class="line">	<span class="keyword">private</span> Bitmap.Config config;</span><br><span class="line">	<span class="keyword">private</span> Priority priority;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后才是请求包装类 RequestCreator.java，在 Request.java 基础上，这个类增加了显示效果的属性，比如淡入、加载中的占位图片、错误图片、tag 以及缓存策略 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestCreator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger nextId = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Picasso picasso;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Request.Builder data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> noFade;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> deferred;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">boolean</span> setPlaceholder = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> placeholderResId;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> errorResId;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> memoryPolicy;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> networkPolicy;</span><br><span class="line">  <span class="keyword">private</span> Drawable placeholderDrawable;</span><br><span class="line">  <span class="keyword">private</span> Drawable errorDrawable;</span><br><span class="line">  <span class="keyword">private</span> Object tag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外，<code>Picasso.with(context).load(&quot;fake_url&quot;).into(someImageView)</code> 中的<code>into</code>方法也是由 RequestCreator.java 类实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">into</span><span class="params">(ImageView target, Callback callback)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> started = System.nanoTime();</span><br><span class="line">	checkMain(); <span class="comment">// 因为要显示在 ImageView 上，所以必须在主线程调用</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Target must not be null."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!data.hasImage()) &#123; <span class="comment">// 取图失败</span></span><br><span class="line">	  picasso.cancelRequest(target);</span><br><span class="line">	  <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">	    setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (deferred) &#123; <span class="comment">// 采用 fit 调整图片大小以适应 ImageView，延时操作</span></span><br><span class="line">	  <span class="keyword">if</span> (data.hasSize()) &#123; <span class="comment">// fit 后自然不能人工设置长宽</span></span><br><span class="line">	    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Fit cannot be used with resize."</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">int</span> width = target.getWidth();</span><br><span class="line">	  <span class="keyword">int</span> height = target.getHeight();</span><br><span class="line">	  <span class="keyword">if</span> (width == <span class="number">0</span> || height == <span class="number">0</span>) &#123;</span><br><span class="line">	    <span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">	      setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">	    &#125;</span><br><span class="line">	    picasso.defer(target, <span class="keyword">new</span> DeferredRequestCreator(<span class="keyword">this</span>, target, callback));</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">	  data.resize(width, height);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Request request = createRequest(started);</span><br><span class="line">	String requestKey = createKey(request); <span class="comment">// cache 的 key</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123; <span class="comment">// 检验内存缓存</span></span><br><span class="line">	  Bitmap bitmap = picasso.quickMemoryCacheCheck(requestKey);</span><br><span class="line">	  <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">	    picasso.cancelRequest(target);</span><br><span class="line">	    setBitmap(target, picasso.context, bitmap, MEMORY, noFade, picasso.indicatorsEnabled);</span><br><span class="line">	    <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">	      log(OWNER_MAIN, VERB_COMPLETED, request.plainId(), <span class="string">"from "</span> + MEMORY);</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">	      callback.onSuccess();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 内存缓存未命中，先显示占位符，然后去网络获取</span></span><br><span class="line">	<span class="keyword">if</span> (setPlaceholder) &#123;</span><br><span class="line">	  setPlaceholder(target, getPlaceholderDrawable());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Action action =</span><br><span class="line">	    <span class="keyword">new</span> ImageViewAction(picasso, target, request, memoryPolicy, networkPolicy, errorResId,</span><br><span class="line">	        errorDrawable, requestKey, tag, callback, noFade);</span><br><span class="line"></span><br><span class="line">	picasso.enqueueAndSubmit(action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中有一个<code>deferred</code>的判断，如果为<code>true</code>则会创建一个<code>DeferredRequestCreator</code>，看一下这个类的实现代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeferredRequestCreator</span> <span class="keyword">implements</span> <span class="title">ViewTreeObserver</span>.<span class="title">OnPreDrawListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> RequestCreator creator;</span><br><span class="line">  <span class="keyword">final</span> WeakReference&lt;ImageView&gt; target;</span><br><span class="line">  Callback callback;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@TestOnly</span> DeferredRequestCreator(RequestCreator creator, ImageView target) &#123;</span><br><span class="line">    <span class="keyword">this</span>(creator, target, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DeferredRequestCreator(RequestCreator creator, ImageView target, Callback callback) &#123;</span><br><span class="line">    <span class="keyword">this</span>.creator = creator;</span><br><span class="line">    <span class="keyword">this</span>.target = <span class="keyword">new</span> WeakReference&lt;ImageView&gt;(target);</span><br><span class="line">    <span class="keyword">this</span>.callback = callback;</span><br><span class="line">    target.getViewTreeObserver().addOnPreDrawListener(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreDraw</span><span class="params">()</span> </span>&#123; <span class="comment">// 覆盖这个方法，以便当ViewTree计算完成准备绘制时，拿到ImageView的长宽</span></span><br><span class="line">    ImageView target = <span class="keyword">this</span>.target.get();</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ViewTreeObserver vto = target.getViewTreeObserver();</span><br><span class="line">    <span class="keyword">if</span> (!vto.isAlive()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> width = target.getWidth();</span><br><span class="line">    <span class="keyword">int</span> height = target.getHeight();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (width &lt;= <span class="number">0</span> || height &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vto.removeOnPreDrawListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.creator.unfit().resize(width, height).into(target, callback); <span class="comment">// 将ImageView长宽传给RequestCreator以便对图片进行resize</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    callback = <span class="keyword">null</span>;</span><br><span class="line">    ImageView target = <span class="keyword">this</span>.target.get();</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ViewTreeObserver vto = target.getViewTreeObserver();</span><br><span class="line">    <span class="keyword">if</span> (!vto.isAlive()) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    vto.removeOnPreDrawListener(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有当在显示图片的地方调用<code>fit()</code>时才会创建<code>DeferredRequestCreator</code>对象。</p>
<p><code>RequestCreator</code>里面有两个字断分别对应着内存设置与网络设置，是缓存策略，对应的枚举类如下，可以看到两者都有<code>NO_CACHE</code> <code>NO_STORE</code>，网络策略枚举里多了一个<code>OFFLINE</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MemoryPolicy &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Skips memory cache lookup when processing a request. */</span></span><br><span class="line">  NO_CACHE(<span class="number">1</span> &lt;&lt; <span class="number">0</span>),</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Skips storing the final result into memory cache. Useful for one-off requests</span></span><br><span class="line"><span class="comment">   * to avoid evicting other bitmaps from the cache.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NO_STORE(<span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldReadFromMemoryCache</span><span class="params">(<span class="keyword">int</span> memoryPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (memoryPolicy &amp; MemoryPolicy.NO_CACHE.index) == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldWriteToMemoryCache</span><span class="params">(<span class="keyword">int</span> memoryPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (memoryPolicy &amp; MemoryPolicy.NO_STORE.index) == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MemoryPolicy</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.index = index;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> NetworkPolicy &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Skips checking the disk cache and forces loading through the network. */</span></span><br><span class="line">  NO_CACHE(<span class="number">1</span> &lt;&lt; <span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Skips storing the result into the disk cache.</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;</span></span><br><span class="line"><span class="comment">   * &lt;em&gt;Note&lt;/em&gt;: At this time this is only supported if you are using OkHttp.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NO_STORE(<span class="number">1</span> &lt;&lt; <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Forces the request through the disk cache only, skipping network. */</span></span><br><span class="line">  OFFLINE(<span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldReadFromDiskCache</span><span class="params">(<span class="keyword">int</span> networkPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (networkPolicy &amp; NetworkPolicy.NO_CACHE.index) == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldWriteToDiskCache</span><span class="params">(<span class="keyword">int</span> networkPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (networkPolicy &amp; NetworkPolicy.NO_STORE.index) == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isOfflineOnly</span><span class="params">(<span class="keyword">int</span> networkPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (networkPolicy &amp; NetworkPolicy.OFFLINE.index) != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">NetworkPolicy</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.index = index;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="缓存管理-LruCache"><a href="#缓存管理-LruCache" class="headerlink" title="缓存管理 LruCache"></a>缓存管理 LruCache</h1><p><code>Picasso.java</code>里维护了一个成员变量<code>cache</code>，对应接口是<code>Cache.java</code>，（只贴出主要代码）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A memory cache for storing the most recently used images.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;em&gt;Note:&lt;/em&gt; The &#123;<span class="doctag">@link</span> Cache&#125; is accessed by multiple threads. You must ensure</span></span><br><span class="line"><span class="comment"> * your &#123;<span class="doctag">@link</span> Cache&#125; implementation is thread safe when &#123;<span class="doctag">@link</span> Cache#get(String)&#125; or &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * Cache#set(String, android.graphics.Bitmap)&#125; is called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** Retrieve an image for the specified &#123;<span class="doctag">@code</span> key&#125; or &#123;<span class="doctag">@code</span> null&#125;. */</span></span><br><span class="line">  <span class="function">Bitmap <span class="title">get</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Store an image in the cache for the specified &#123;<span class="doctag">@code</span> key&#125;. */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(String key, Bitmap bitmap)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns the current size of the cache in bytes. */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns the maximum size in bytes that the cache can hold. */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">maxSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Clears the cache. */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单的几个接口，需要注意的是在实现过程中要保证get/set的线程安全。对应的实现类是<code>LruCache.java</code>，这是<code>LruCache</code>一个很漂亮的实现，该有的功能都有，丝毫不拖泥带水，我忍不住把整个类都贴出来。单词<code>eviction</code>的翻译是<code>驱逐</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** A memory cache which uses a least-recently used eviction policy. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LruCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> LinkedHashMap&lt;String, Bitmap&gt; map; <span class="comment">// 有序 map</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxSize;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> putCount;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> evictionCount;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> hitCount; <span class="comment">// 命中计数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> missCount; <span class="comment">// 未命中计数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Create a cache using an appropriate portion of the available RAM as the maximum size. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(Utils.calculateMemoryCacheSize(context)); <span class="comment">// Utils.java 里用于计算内存的工具方法，返回的数值是1/7（约15%）应用可用内存。</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Create a cache with a given maximum size in bytes. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Max size must be positive."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.maxSize = maxSize;</span><br><span class="line">    <span class="keyword">this</span>.map = <span class="keyword">new</span> LinkedHashMap&lt;String, Bitmap&gt;(<span class="number">0</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>); <span class="comment">// 第三个参数 true 表示 LinkedHashMap 的排序是按照最近 access，false则为最近 insertion</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Bitmap <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Bitmap mapValue;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; <span class="comment">// 前面说了，get/set必须要做同步控制</span></span><br><span class="line">      mapValue = map.get(key);</span><br><span class="line">      <span class="keyword">if</span> (mapValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">        hitCount++;</span><br><span class="line">        <span class="keyword">return</span> mapValue;</span><br><span class="line">      &#125;</span><br><span class="line">      missCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"key == null || bitmap == null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Bitmap previous;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; <span class="comment">// 一样的同步</span></span><br><span class="line">      putCount++;</span><br><span class="line">      size += Utils.getBitmapBytes(bitmap);</span><br><span class="line">      previous = map.put(key, bitmap);</span><br><span class="line">      <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</span><br><span class="line">        size -= Utils.getBitmapBytes(previous);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    trimToSize(maxSize); <span class="comment">// 若尺寸超过 maxSize 则需要清理</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      String key;</span><br><span class="line">      Bitmap value;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123; <span class="comment">// 凡是所有操作 map 的地方都加锁</span></span><br><span class="line">        <span class="keyword">if</span> (size &lt; <span class="number">0</span> || (map.isEmpty() &amp;&amp; size != <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">              getClass().getName() + <span class="string">".sizeOf() is reporting inconsistent results!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &lt;= maxSize || map.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map.Entry&lt;String, Bitmap&gt; toEvict = map.entrySet().iterator().next();</span><br><span class="line">        key = toEvict.getKey();</span><br><span class="line">        value = toEvict.getValue();</span><br><span class="line">        map.remove(key); <span class="comment">// 清理出 map，由 GC 自动回收</span></span><br><span class="line">        size -= Utils.getBitmapBytes(value);</span><br><span class="line">        evictionCount++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Clear the cache. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">evictAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    trimToSize(-<span class="number">1</span>); <span class="comment">// -1 will evict 0-sized elements</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">maxSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> maxSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    evictAll();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">clearKeyUri</span><span class="params">(String uri)</span> </span>&#123; <span class="comment">// 清除某个 URI 对应的全部图片，同样内容的图片因为尺寸缩放旋转不同，会在 cache 里存在多个实例</span></span><br><span class="line">    <span class="keyword">boolean</span> sizeChanged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">int</span> uriLength = uri.length();</span><br><span class="line">    <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String, Bitmap&gt;&gt; i = map.entrySet().iterator(); i.hasNext();) &#123;</span><br><span class="line">      Map.Entry&lt;String, Bitmap&gt; entry = i.next();</span><br><span class="line">      String key = entry.getKey();</span><br><span class="line">      Bitmap value = entry.getValue();</span><br><span class="line">      <span class="keyword">int</span> newlineIndex = key.indexOf(KEY_SEPARATOR);</span><br><span class="line">      <span class="keyword">if</span> (newlineIndex == uriLength &amp;&amp; key.substring(<span class="number">0</span>, newlineIndex).equals(uri)) &#123;</span><br><span class="line">        i.remove();</span><br><span class="line">        size -= Utils.getBitmapBytes(value);</span><br><span class="line">        sizeChanged = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sizeChanged) &#123;</span><br><span class="line">      trimToSize(maxSize);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns the number of times &#123;<span class="doctag">@link</span> #get&#125; returned a value. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hitCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hitCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns the number of times &#123;<span class="doctag">@link</span> #get&#125; returned &#123;<span class="doctag">@code</span> null&#125;. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">missCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> missCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns the number of times &#123;<span class="doctag">@link</span> #set(String, Bitmap)&#125; was called. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">putCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Returns the number of values that have been evicted. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">evictionCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> evictionCount;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>知道了 cache 的用法，就可以很好地在<code>Picasso.java</code>里面检查 cache 了，用起来十分简单。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Bitmap <span class="title">quickMemoryCacheCheck</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">	Bitmap cached = cache.get(key);</span><br><span class="line">	<span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">	  stats.dispatchCacheHit();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	  stats.dispatchCacheMiss();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cached;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="请求处理器-RequestHandler"><a href="#请求处理器-RequestHandler" class="headerlink" title="请求处理器 RequestHandler"></a>请求处理器 RequestHandler</h1><p>在 Picasso.java 的构造函数里，有这样一段初始化代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Picasso(Context context, Dispatcher dispatcher, Cache cache, Listener listener,</span><br><span class="line">  RequestTransformer requestTransformer, List&lt;RequestHandler&gt; extraRequestHandlers, Stats stats,</span><br><span class="line">      Bitmap.Config defaultBitmapConfig, <span class="keyword">boolean</span> indicatorsEnabled, <span class="keyword">boolean</span> loggingEnabled) &#123;</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> ResourceRequestHandler(context));</span><br><span class="line">    <span class="keyword">if</span> (extraRequestHandlers != <span class="keyword">null</span>) &#123;</span><br><span class="line">      allRequestHandlers.addAll(extraRequestHandlers);</span><br><span class="line">    &#125;</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> ContactsPhotoRequestHandler(context));</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> MediaStoreRequestHandler(context));</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> ContentStreamRequestHandler(context));</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> AssetRequestHandler(context));</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> FileRequestHandler(context));</span><br><span class="line">    allRequestHandlers.add(<span class="keyword">new</span> NetworkRequestHandler(dispatcher.downloader, stats));</span><br><span class="line">    requestHandlers = Collections.unmodifiableList(allRequestHandlers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出这是实现了多种请求处理类，所有的<code>XXXRequetHandler</code>类都继承自抽象类<code>RequestHandler.java</code>，其中最重要的是<code>canHandleRequest</code>和<code>load</code>这两个方法。源码注释里给出了简洁的说明，不再赘述。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Whether or not this &#123;<span class="doctag">@link</span> RequestHandler&#125; can handle a request with the given &#123;<span class="doctag">@link</span> Request&#125;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">canHandleRequest</span><span class="params">(Request data)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Loads an image for the given &#123;<span class="doctag">@link</span> Request&#125;.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> request the data from which the image should be resolved.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> networkPolicy the &#123;<span class="doctag">@link</span> NetworkPolicy&#125; for this request.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Result <span class="title">load</span><span class="params">(Request request, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看一下<code>NetworkRequestHandler</code>类的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NetworkRequestHandler</span> <span class="keyword">extends</span> <span class="title">RequestHandler</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_COUNT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCHEME_HTTP = <span class="string">"http"</span>; <span class="comment">// 这两个常量用于判断 url</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCHEME_HTTPS = <span class="string">"https"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Downloader downloader; <span class="comment">// 下载器，有 OkHttp 和 URLConnectionDownloader 两种实现，稍后讲解</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Stats stats;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NetworkRequestHandler</span><span class="params">(Downloader downloader, Stats stats)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.downloader = downloader;</span><br><span class="line">    <span class="keyword">this</span>.stats = stats;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canHandleRequest</span><span class="params">(Request data)</span> </span>&#123;</span><br><span class="line">    String scheme = data.uri.getScheme(); <span class="comment">// 从 scheme 判断是否为网络图片请求</span></span><br><span class="line">    <span class="keyword">return</span> (SCHEME_HTTP.equals(scheme) || SCHEME_HTTPS.equals(scheme));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Result <span class="title">load</span><span class="params">(Request request, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Response response = downloader.load(request.uri, request.networkPolicy); <span class="comment">// 同步下载</span></span><br><span class="line">    <span class="keyword">if</span> (response == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Picasso.LoadedFrom loadedFrom = response.cached ? DISK : NETWORK;</span><br><span class="line"></span><br><span class="line">    Bitmap bitmap = response.getBitmap();</span><br><span class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123; <span class="comment">// 直接拿到 Bitmap，则返回</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Result(bitmap, loadedFrom);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InputStream is = response.getInputStream(); <span class="comment">// 拿到输入流，需要解析成 Bitmap </span></span><br><span class="line">    <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Sometimes response content length is zero when requests are being replayed. Haven't found</span></span><br><span class="line">    <span class="comment">// root cause to this but retrying the request seems safe to do so.</span></span><br><span class="line">    <span class="keyword">if</span> (loadedFrom == DISK &amp;&amp; response.getContentLength() == <span class="number">0</span>) &#123;</span><br><span class="line">      Utils.closeQuietly(is);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ContentLengthException(<span class="string">"Received response with 0 content-length header."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (loadedFrom == NETWORK &amp;&amp; response.getContentLength() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      stats.dispatchDownloadFinished(response.getContentLength());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Result(is, loadedFrom);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到它是将下载任务委托给了<code>Downloader</code>进行，<code>Downloader</code>的注释里描述的很清楚，它是“A mechanism to load images from external resources such as a disk cache and/or the internet.”，用于加载外部图片（相比于内存缓存而言）。最主要的是<code>load</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Response <span class="title">load</span><span class="params">(Uri uri, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>其中<code>Response</code>的结构是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> InputStream stream;</span><br><span class="line">	<span class="keyword">final</span> Bitmap bitmap;</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">boolean</span> cached; <span class="comment">// 图片是否来源自磁盘缓存（local disk cache）</span></span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">long</span> contentLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Downloader</code>有两个实现</p>
<ul>
<li>OKHttpDownloader，对应 Android 版本 &gt;= 4.4</li>
<li>URLConnectionDownloader，对应 Android 版本 &lt; 4.4</li>
</ul>
<p>判断代码位于<code>Utils.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Downloader <span class="title">createDefaultDownloader</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	  Class.forName(<span class="string">"com.squareup.okhttp.OkHttpClient"</span>);</span><br><span class="line">	  <span class="keyword">return</span> OkHttpLoaderCreator.create(context);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (ClassNotFoundException ignored) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> UrlConnectionDownloader(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OKHttpDownloader</code>里面的<code>load</code>方法，采用 square 自家的<code>OKHttp</code>进行下载，在构建其 Builder 时决定是否使用磁盘缓存。换言之，虽然<code>Picasso</code>声称有内存+磁盘两级缓存，其磁盘缓存其实是借助<code>OKHttp</code>实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Response <span class="title">load</span><span class="params">(Uri uri, <span class="keyword">int</span> networkPolicy)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	CacheControl cacheControl = <span class="keyword">null</span>; <span class="comment">// 这个 CacheControl 是 OKHttp 里面的类</span></span><br><span class="line">	<span class="keyword">if</span> (networkPolicy != <span class="number">0</span>) &#123;</span><br><span class="line">	  <span class="keyword">if</span> (NetworkPolicy.isOfflineOnly(networkPolicy)) &#123;</span><br><span class="line">	    cacheControl = CacheControl.FORCE_CACHE;</span><br><span class="line">	  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	    CacheControl.Builder builder = <span class="keyword">new</span> CacheControl.Builder();</span><br><span class="line">	    <span class="keyword">if</span> (!NetworkPolicy.shouldReadFromDiskCache(networkPolicy)) &#123;</span><br><span class="line">	      builder.noCache();</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (!NetworkPolicy.shouldWriteToDiskCache(networkPolicy)) &#123;</span><br><span class="line">	      builder.noStore();</span><br><span class="line">	    &#125;</span><br><span class="line">	    cacheControl = builder.build();</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Request.Builder builder = <span class="keyword">new</span> Request.Builder().url(uri.toString());</span><br><span class="line">	<span class="keyword">if</span> (cacheControl != <span class="keyword">null</span>) &#123;</span><br><span class="line">	  builder.cacheControl(cacheControl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	com.squareup.okhttp.Response response = client.newCall(builder.build()).execute(); <span class="comment">// 同步接口</span></span><br><span class="line">	<span class="keyword">int</span> responseCode = response.code();</span><br><span class="line">	<span class="keyword">if</span> (responseCode &gt;= <span class="number">300</span>) &#123;</span><br><span class="line">	  response.body().close();</span><br><span class="line">	  <span class="keyword">throw</span> <span class="keyword">new</span> ResponseException(responseCode + <span class="string">" "</span> + response.message(), networkPolicy,</span><br><span class="line">	      responseCode);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> fromCache = response.cacheResponse() != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	ResponseBody responseBody = response.body();</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Response(responseBody.byteStream(), fromCache, responseBody.contentLength());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此<code>RequestHandler</code>的分析已经完成，虽然它名为 Handler，但实际上并没有包含工作线程一类的东西，这部分相关代码实际上位于<code>Dispatcher.java</code>中。</p>
<h1 id="任务调度器-Dispatcher"><a href="#任务调度器-Dispatcher" class="headerlink" title="任务调度器 Dispatcher"></a>任务调度器 Dispatcher</h1><p>理解<code>Dispatcher</code>之前，我们需要先了解一下任务类<code>Action.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Action</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestWeakReference</span>&lt;<span class="title">M</span>&gt; <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">M</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Action action;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestWeakReference</span><span class="params">(Action action, M referent, ReferenceQueue&lt;? <span class="keyword">super</span> M&gt; q)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>(referent, q);</span><br><span class="line">      <span class="keyword">this</span>.action = action;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Picasso picasso;</span><br><span class="line">  <span class="keyword">final</span> Request request;</span><br><span class="line">  <span class="keyword">final</span> WeakReference&lt;T&gt; target;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> noFade;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> memoryPolicy;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> networkPolicy;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> errorResId;</span><br><span class="line">  <span class="keyword">final</span> Drawable errorDrawable;</span><br><span class="line">  <span class="keyword">final</span> String key;</span><br><span class="line">  <span class="keyword">final</span> Object tag;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> willReplay;</span><br><span class="line">  <span class="keyword">boolean</span> cancelled;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(Bitmap result, Picasso.LoadedFrom from)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>Action</code>可以理解成一项图片加载任务，它组合了之前介绍的<code>Request</code>和<code>RequestCreator</code>的内容，且包含加载成功/失败的回调。</p>
<p>所有的<code>Action</code>任务都会被丢给<code>Dispatcher</code>执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RETRY_DELAY = <span class="number">500</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AIRPLANE_MODE_ON = <span class="number">1</span>; <span class="comment">// 飞行模式，会影响并发线程数</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AIRPLANE_MODE_OFF = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_SUBMIT = <span class="number">1</span>; <span class="comment">// 消息类型，供 handler 使用</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CANCEL = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_GCED = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HUNTER_COMPLETE = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HUNTER_RETRY = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HUNTER_DECODE_FAILED = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HUNTER_DELAY_NEXT_BATCH = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HUNTER_BATCH_COMPLETE = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NETWORK_STATE_CHANGE = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> AIRPLANE_MODE_CHANGE = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TAG_PAUSE = <span class="number">11</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TAG_RESUME = <span class="number">12</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_BATCH_RESUME = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISPATCHER_THREAD_NAME = <span class="string">"Dispatcher"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_DELAY = <span class="number">200</span>; <span class="comment">// ms</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> DispatcherThread dispatcherThread; <span class="comment">// 调度器线程</span></span><br><span class="line">  <span class="keyword">final</span> Context context;</span><br><span class="line">  <span class="keyword">final</span> ExecutorService service; <span class="comment">// 线程池</span></span><br><span class="line">  <span class="keyword">final</span> Downloader downloader; <span class="comment">// 下载器</span></span><br><span class="line">  <span class="keyword">final</span> Map&lt;String, BitmapHunter&gt; hunterMap; <span class="comment">// 线程 map</span></span><br><span class="line">  <span class="keyword">final</span> Map&lt;Object, Action&gt; failedActions;</span><br><span class="line">  <span class="keyword">final</span> Map&lt;Object, Action&gt; pausedActions;</span><br><span class="line">  <span class="keyword">final</span> Set&lt;Object&gt; pausedTags;</span><br><span class="line">  <span class="keyword">final</span> Handler handler; <span class="comment">// DispatchHandler</span></span><br><span class="line">  <span class="keyword">final</span> Handler mainThreadHandler; <span class="comment">// UI 变更</span></span><br><span class="line">  <span class="keyword">final</span> Cache cache;</span><br><span class="line">  <span class="keyword">final</span> Stats stats; <span class="comment">// 统计数据，包含命中缓存、未命中缓存、解码、下载计数</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;BitmapHunter&gt; batch;</span><br><span class="line">  <span class="keyword">final</span> NetworkBroadcastReceiver receiver; <span class="comment">// 监听网络变化，调整并发线程数</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> scansNetworkChanges;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> airplaneMode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然名为<code>Dispatcher</code>，肯定少不了<code>dispatchXXX</code>的方法，它们的处理方法完全一样，都是把消息丢给<code>DispatchHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchSubmit</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">  handler.sendMessage(handler.obtainMessage(REQUEST_SUBMIT, action));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchCancel</span><span class="params">(Action action)</span> </span>&#123;</span><br><span class="line">  handler.sendMessage(handler.obtainMessage(REQUEST_CANCEL, action));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatchPauseTag</span><span class="params">(Object tag)</span> </span>&#123;</span><br><span class="line">  handler.sendMessage(handler.obtainMessage(TAG_PAUSE, tag));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下还有 dispatchResumeTag、dispatchComplete、dispatchRetry，略</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DispatchHandler</code>是用于接收处理这些消息的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Dispatcher dispatcher;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DispatcherHandler</span><span class="params">(Looper looper, Dispatcher dispatcher)</span> </span>&#123;</span><br><span class="line">	  <span class="keyword">super</span>(looper);</span><br><span class="line">	  <span class="keyword">this</span>.dispatcher = dispatcher;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(<span class="keyword">final</span> Message msg)</span> </span>&#123;</span><br><span class="line">	  <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">	    <span class="keyword">case</span> REQUEST_SUBMIT: &#123;</span><br><span class="line">	      Action action = (Action) msg.obj;</span><br><span class="line">	      dispatcher.performSubmit(action);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> REQUEST_CANCEL: &#123;</span><br><span class="line">	      Action action = (Action) msg.obj;</span><br><span class="line">	      dispatcher.performCancel(action);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> TAG_PAUSE: &#123;</span><br><span class="line">	      Object tag = msg.obj;</span><br><span class="line">	      dispatcher.performPauseTag(tag);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> TAG_RESUME: &#123;</span><br><span class="line">	      Object tag = msg.obj;</span><br><span class="line">	      dispatcher.performResumeTag(tag);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> HUNTER_COMPLETE: &#123;</span><br><span class="line">	      BitmapHunter hunter = (BitmapHunter) msg.obj;</span><br><span class="line">	      dispatcher.performComplete(hunter);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> HUNTER_RETRY: &#123;</span><br><span class="line">	      BitmapHunter hunter = (BitmapHunter) msg.obj;</span><br><span class="line">	      dispatcher.performRetry(hunter);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> HUNTER_DECODE_FAILED: &#123;</span><br><span class="line">	      BitmapHunter hunter = (BitmapHunter) msg.obj;</span><br><span class="line">	      dispatcher.performError(hunter, <span class="keyword">false</span>);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> HUNTER_DELAY_NEXT_BATCH: &#123;</span><br><span class="line">	      dispatcher.performBatchComplete();</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> NETWORK_STATE_CHANGE: &#123;</span><br><span class="line">	      NetworkInfo info = (NetworkInfo) msg.obj;</span><br><span class="line">	      dispatcher.performNetworkStateChange(info);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">case</span> AIRPLANE_MODE_CHANGE: &#123;</span><br><span class="line">	      dispatcher.performAirplaneModeChange(msg.arg1 == AIRPLANE_MODE_ON);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">default</span>:</span><br><span class="line">	      Picasso.HANDLER.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">	        <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	          <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Unknown handler message received: "</span> + msg.what);</span><br><span class="line">	        &#125;</span><br><span class="line">	      &#125;);</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，处理手段是取出消息里的<code>Action</code>，然后调用<code>Dispatcher</code>中<code>performXXX</code>直接进行处理。这种<code>Dispatcher</code>组合<code>Handler</code>的模式值得学习借鉴。接下来我们具体看一下<code>performSubmit</code>也就是提交一个图片加载请求具体是怎么实现的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">performSubmit</span><span class="params">(Action action, <span class="keyword">boolean</span> dismissFailed)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (pausedTags.contains(action.getTag())) &#123; <span class="comment">// 如果请求已经被 pause，则不继续向下处理</span></span><br><span class="line">	  pausedActions.put(action.getTarget(), action);</span><br><span class="line">	  <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</span><br><span class="line">	    log(OWNER_DISPATCHER, VERB_PAUSED, action.request.logId(),</span><br><span class="line">	        <span class="string">"because tag '"</span> + action.getTag() + <span class="string">"' is paused"</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	BitmapHunter hunter = hunterMap.get(action.getKey());</span><br><span class="line">	<span class="keyword">if</span> (hunter != <span class="keyword">null</span>) &#123; <span class="comment">// BitmapHunter 是工作线程类（实现 Runnable 接口），若一张图片已经有工作线程在处理，则将当前 Action 附到工作线程的队列中</span></span><br><span class="line">	  hunter.attach(action);</span><br><span class="line">	  <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (service.isShutdown()) &#123; <span class="comment">// 线程池已停止</span></span><br><span class="line">	  <span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</span><br><span class="line">	    log(OWNER_DISPATCHER, VERB_IGNORED, action.request.logId(), <span class="string">"because shut down"</span>);</span><br><span class="line">	  &#125;</span><br><span class="line">	  <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 生成一个 BitmapHunter</span></span><br><span class="line">	hunter = forRequest(action.getPicasso(), <span class="keyword">this</span>, cache, stats, action);</span><br><span class="line">	hunter.future = service.submit(hunter); <span class="comment">// 这里很重要，提交一个 Runnable 给线程池</span></span><br><span class="line">	hunterMap.put(action.getKey(), hunter); <span class="comment">// 存进工作线程 Map</span></span><br><span class="line">	<span class="keyword">if</span> (dismissFailed) &#123;</span><br><span class="line">	  failedActions.remove(action.getTarget());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (action.getPicasso().loggingEnabled) &#123;</span><br><span class="line">	  log(OWNER_DISPATCHER, VERB_ENQUEUED, action.request.logId());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="职责重大的-BitmapHunter"><a href="#职责重大的-BitmapHunter" class="headerlink" title="职责重大的 BitmapHunter"></a>职责重大的 BitmapHunter</h1><p><code>BitmapHunter</code>实现了<code>Runnable</code>接口，<code>run</code>方法可以看作对一次图片请求的完整处理过程，也就是文初提到的“获取 - 变换 - 显示”。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapHunter</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> sequence; <span class="comment">// 序列号，基于 AtomicInteger 实现</span></span><br><span class="line">  <span class="keyword">final</span> Picasso picasso; <span class="comment">// 单例</span></span><br><span class="line">  <span class="keyword">final</span> Dispatcher dispatcher; <span class="comment">// 任务调度器</span></span><br><span class="line">  <span class="keyword">final</span> Cache cache;</span><br><span class="line">  <span class="keyword">final</span> Stats stats;</span><br><span class="line">  <span class="keyword">final</span> String key;</span><br><span class="line">  <span class="keyword">final</span> Request data;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> memoryPolicy;</span><br><span class="line">  <span class="keyword">int</span> networkPolicy;</span><br><span class="line">  <span class="keyword">final</span> RequestHandler requestHandler;</span><br><span class="line"></span><br><span class="line">  Action action;</span><br><span class="line">  List&lt;Action&gt; actions; <span class="comment">// 一个 BitmapHunter 可以处理多个 Action</span></span><br><span class="line">  Bitmap result;</span><br><span class="line">  Future&lt;?&gt; future;</span><br><span class="line">  Picasso.LoadedFrom loadedFrom;</span><br><span class="line">  Exception exception;</span><br><span class="line">  <span class="keyword">int</span> exifRotation; <span class="comment">// Determined during decoding of original resource.</span></span><br><span class="line">  <span class="keyword">int</span> retryCount;</span><br><span class="line">  Priority priority;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>EXIF（Exchangeable Image File）是“可交换图像文件”的缩写，当中包含了专门为数码相机的照片而定制的元数据，可以记录数码照片的拍摄参数、缩略图及其他属性信息。很多图像编辑器会自动读取Exif数据来对图像进行优化，最常见的便是从 Exif中读取出<strong>相机姿态</strong>信息，从而自动识别出竖拍甚至是颠倒拍摄的照片并对其进行<strong>旋转</strong>校正。</p>
</blockquote>
<p><code>run()</code>方法是对图片的处理流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    updateThreadName(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">      log(OWNER_HUNTER, VERB_EXECUTING, getLogIdsForHunter(<span class="keyword">this</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = hunt(); <span class="comment">// 同步获取结果</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123; <span class="comment">// 通知 Dispatcher 任务完成</span></span><br><span class="line">      dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      dispatcher.dispatchComplete(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Downloader.ResponseException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!e.localCacheOnly || e.responseCode != <span class="number">504</span>) &#123;</span><br><span class="line">      exception = e;</span><br><span class="line">    &#125;</span><br><span class="line">    dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NetworkRequestHandler.ContentLengthException e) &#123; <span class="comment">// 非常细节的错误处理</span></span><br><span class="line">    exception = e;</span><br><span class="line">    dispatcher.dispatchRetry(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    exception = e;</span><br><span class="line">    dispatcher.dispatchRetry(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">    StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">    stats.createSnapshot().dump(<span class="keyword">new</span> PrintWriter(writer));</span><br><span class="line">    exception = <span class="keyword">new</span> RuntimeException(writer.toString(), e);</span><br><span class="line">    dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    exception = e;</span><br><span class="line">    dispatcher.dispatchFailed(<span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    Thread.currentThread().setName(Utils.THREAD_IDLE_NAME);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见对图片的获取和处理在<code>hunt</code>中，对得起<code>BitmapHunter</code>这个名字</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Bitmap <span class="title">hunt</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Bitmap bitmap = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shouldReadFromMemoryCache(memoryPolicy)) &#123; <span class="comment">// 检查内存缓存</span></span><br><span class="line">    bitmap = cache.get(key);</span><br><span class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">      stats.dispatchCacheHit();</span><br><span class="line">      loadedFrom = MEMORY;</span><br><span class="line">      <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">        log(OWNER_HUNTER, VERB_DECODED, data.logId(), <span class="string">"from cache"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  data.networkPolicy = retryCount == <span class="number">0</span> ? NetworkPolicy.OFFLINE.index : networkPolicy;</span><br><span class="line">  RequestHandler.Result result = requestHandler.load(data, networkPolicy); <span class="comment">// 调用 handler 同步获取结果</span></span><br><span class="line">  <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">    loadedFrom = result.getLoadedFrom();</span><br><span class="line">    exifRotation = result.getExifOrientation(); <span class="comment">// 从 exif 里获取旋转角度</span></span><br><span class="line"></span><br><span class="line">    bitmap = result.getBitmap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there was no Bitmap then we need to decode it from the stream.</span></span><br><span class="line">    <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</span><br><span class="line">      InputStream is = result.getStream(); <span class="comment">// 解码图片</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        bitmap = decodeStream(is, data);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Utils.closeQuietly(is); <span class="comment">// quietly 的含义是无视所有异常</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123; <span class="comment">// 取到解码后的图片，进行转换和显示</span></span><br><span class="line">    <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">      log(OWNER_HUNTER, VERB_DECODED, data.logId());</span><br><span class="line">    &#125;</span><br><span class="line">    stats.dispatchBitmapDecoded(bitmap); <span class="comment">// 这里只是计数，并未操作转换</span></span><br><span class="line">    <span class="keyword">if</span> (data.needsTransformation() || exifRotation != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (DECODE_LOCK) &#123; <span class="comment">// 必须加锁，同一时间只能处理一张图片，防止 OOM</span></span><br><span class="line">        <span class="keyword">if</span> (data.needsMatrixTransform() || exifRotation != <span class="number">0</span>) &#123;</span><br><span class="line">          bitmap = transformResult(data, bitmap, exifRotation); <span class="comment">// 运用 matrix 的 scale 与 rotate 处理图片</span></span><br><span class="line">          <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">            log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId());</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (data.hasCustomTransformations()) &#123; <span class="comment">// 自定义转换，比如圆角</span></span><br><span class="line">          bitmap = applyCustomTransformations(data.transformations, bitmap);</span><br><span class="line">          <span class="keyword">if</span> (picasso.loggingEnabled) &#123;</span><br><span class="line">            log(OWNER_HUNTER, VERB_TRANSFORMED, data.logId(), <span class="string">"from custom transformations"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        stats.dispatchBitmapTransformed(bitmap);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bitmap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，整个图片的加载流程基本分析完成，下面是一个完整的类图，出处见文末。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/img/180703_picasso/picasso_classes_relation.png" alt="类图" title="">
                </div>
                <div class="image-caption">类图</div>
            </figure>
<h1 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h1><p>在我看来，做一个开源项目的源码解读，一般有两个切入点。</p>
<ol>
<li>先反问自己一个问题，“如果让你实现一个 XX 框架，你会怎么设计？”，画出流程图，列出承担主要职责的类；然后再对照着自己的设计，去阅读并理解项目代码。我把它叫做<code>自顶向下</code>。</li>
<li>从项目代码的入口开始（一般是函数调用处），逐级追踪，弄清楚每一步涉及到哪些类，它们的职责是什么，这样最后会有一个链式的调用在你脑海中。我把它叫做<code>自底向上</code>。</li>
</ol>
<p>方法 1 能让你在开始时纵览全局，对每一个模块有大致的轮廓，随着逐步深入学习代码，对其认识会进一步加深，最后化为己用；但缺点也很明显，你不可能一上来就把流程图、类图绘制地明明白白，需要你对项目代码有一些理解，也许还需要一定的设计模式知识。方法 2 容易上手，如果项目简单还好，若是复杂项目很容易让人迷失其中。本文采用的是方法 1 的思路，以下两篇文章分别对应方法 1 和 2，它们在我写本文的过程中提供了大量帮助，非常感谢原作者。</p>
<ol>
<li><a href="https://juejin.im/entry/5aba4fc46fb9a028da7c8ef4" target="_blank" rel="noopener">Android 面试助力：一次读懂热门图片框架 Picasso 源码及流程</a></li>
<li><a href="https://skykai521.github.io/2016/02/25/Picasso%E6%BA%90%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">Picasso源代码分析</a></li>
</ol>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2018-07-06T07:37:50.118Z" itemprop="dateUpdated">2018-07-06 15:37:50</time>
</span><br>


        
        这里可以写作者留言，标签和 hexo 中所有变量及辅助函数等均可调用，示例：<a href="/2018/07/03/picasso/" target="_blank" rel="external">https://lilei.pro/2018/07/03/picasso/</a>
        
    </div>
    
    <footer>
        <a href="https://lilei.pro">
            <img src="/img/avatar.jpeg" alt="Li Lei">
            Li Lei
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/源码学习/">源码学习</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://lilei.pro/2018/07/03/picasso/&title=《Picasso 源码学习》 — 柘个角落&pic=https://lilei.pro/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://lilei.pro/2018/07/03/picasso/&title=《Picasso 源码学习》 — 柘个角落&source=技术与生活上的点滴积累" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://lilei.pro/2018/07/03/picasso/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Picasso 源码学习》 — 柘个角落&url=https://lilei.pro/2018/07/03/picasso/&via=https://lilei.pro" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://lilei.pro/2018/07/03/picasso/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/07/06/okhttp/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">OkHttp 源码学习</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/06/26/todo-mvp/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Google Architecture Sample TODO MVP 学习</h4>
      </a>
    </div>
  
</nav>



    

















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Li Lei &copy; 2015 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://lilei.pro/2018/07/03/picasso/&title=《Picasso 源码学习》 — 柘个角落&pic=https://lilei.pro/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://lilei.pro/2018/07/03/picasso/&title=《Picasso 源码学习》 — 柘个角落&source=技术与生活上的点滴积累" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://lilei.pro/2018/07/03/picasso/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Picasso 源码学习》 — 柘个角落&url=https://lilei.pro/2018/07/03/picasso/&via=https://lilei.pro" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://lilei.pro/2018/07/03/picasso/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABwklEQVR42u3aQYrDMAwF0Nz/0h2YVWGK82XZThmeVyWkyXMWQpZ0XfF6/a7xlffr72t8z7Vj4eLitrmv4fqLS+4c/zd/5oct4eLiHuSOg1cSnvKANd7SjQ0XF/fLuNUtjTeGi4v7P7hrz1i4uLjfz+0caeaC2vazGi4uboPbCTqrfm+s7+Li4ha5r+KqNkKSUFh4Oy4u7hHuXAO12mqtpkQ3YQ4XF3czNzmcJK8ZP63w5cYqXFzcg9y5QkZC7IxffHgvLi7uQ9y5B+XN1DwxigIZLi7uNu5cs3MtPfocuLi4R7hzIxedNGjxeAcuLu4G7lwgqw5yVT8KLi7us9xOyjJHqR5+btoquLi4G7jRuEN8BOoMc0ShExcX9yA3OaLkG8uHscrJEy4u7hFupxSSUBJQdcO4uLi7udXhiWpbtDVsgYuL+yj3ilenVFru6uDi4j7KrRYy8gDXadYWoiYuLu5S7lwI65dC5p6Ji4t7kltteOSl1bmW6s0XxcXFPcitHmn6xdNqeoSLi/ud3DwMjQsi1TA3GchwcXEPcqtDFZ0OMC4u7rPcVSlLngZNFk1wcXGPcNe2V6tJzGQ4w8XF3cX9AR8Rdp2jTws7AAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
