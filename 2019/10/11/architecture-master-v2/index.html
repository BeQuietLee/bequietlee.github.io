<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>架构学习之 master-v2 | 柘个角落 | IF YOU WANT SOMETHING, GO GET IT. PERIOD.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="架构">
    <meta name="description" content="Move stones, not mountains.  Google 官方的 Android Architecture Blueprints 推出了 v2 版本，相比于之前的 v1 版本，v2 采取了更先进的设计思想与组件：  采用 Kotlin Coroutines 处理后台操作 单一 Activity 结构，用 Navigation component 处理Fragment 之间跳转 由">
<meta name="keywords" content="架构">
<meta property="og:type" content="article">
<meta property="og:title" content="架构学习之 master-v2">
<meta property="og:url" content="https://lilei.pro/2019/10/11/architecture-master-v2/index.html">
<meta property="og:site_name" content="柘个角落">
<meta property="og:description" content="Move stones, not mountains.  Google 官方的 Android Architecture Blueprints 推出了 v2 版本，相比于之前的 v1 版本，v2 采取了更先进的设计思想与组件：  采用 Kotlin Coroutines 处理后台操作 单一 Activity 结构，用 Navigation component 处理Fragment 之间跳转 由">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://lilei.pro/img/191011_architecture_master_v2/jetpack.png">
<meta property="og:image" content="https://lilei.pro/img/191011_architecture_master_v2/viewmodel.png">
<meta property="og:updated_time" content="2019-10-11T15:54:24.831Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="架构学习之 master-v2">
<meta name="twitter:description" content="Move stones, not mountains.  Google 官方的 Android Architecture Blueprints 推出了 v2 版本，相比于之前的 v1 版本，v2 采取了更先进的设计思想与组件：  采用 Kotlin Coroutines 处理后台操作 单一 Activity 结构，用 Navigation component 处理Fragment 之间跳转 由">
<meta name="twitter:image" content="https://lilei.pro/img/191011_architecture_master_v2/jetpack.png">
    
        <link rel="alternate" type="application/atom+xml" title="柘个角落" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">Li Lei</h5>
          <a href="mailto:bequietlee#gmail.com" title="bequietlee#gmail.com" class="mail">bequietlee#gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                文章
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/bequietlee" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/2019/03/10/links"  >
                <i class="icon icon-lg icon-link"></i>
                友情链接
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">架构学习之 master-v2</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">架构学习之 master-v2</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-10-11T15:50:24.000Z" itemprop="datePublished" class="page-time">
  2019-10-11
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#程序入口"><span class="post-toc-number">1.</span> <span class="post-toc-text">程序入口</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#数据"><span class="post-toc-number">2.</span> <span class="post-toc-text">数据</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Result-kt-与-Task-kt"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">Result.kt 与 Task.kt</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#数据接口：TasksDataSource-kt-与-TasksRepository-kt"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">数据接口：TasksDataSource.kt 与 TasksRepository.kt</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#local-目录：本地数据实现"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">local 目录：本地数据实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#数据层总结"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">数据层总结</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#ViewModel"><span class="post-toc-number">3.</span> <span class="post-toc-text">ViewModel</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#背景知识：ViewModel-与-LiveData"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">背景知识：ViewModel 与 LiveData</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ViewModelFactory"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">ViewModelFactory</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TasksViewModel"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">TasksViewModel</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#视图"><span class="post-toc-number">4.</span> <span class="post-toc-text">视图</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">5.</span> <span class="post-toc-text">总结</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Bonus：usecases"><span class="post-toc-number">6.</span> <span class="post-toc-text">Bonus：usecases</span></a></li></ol>
        </nav>
    </aside>


<article id="post-architecture-master-v2"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">架构学习之 master-v2</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-10-11 23:50:24" datetime="2019-10-11T15:50:24.000Z"  itemprop="datePublished">2019-10-11</time>

            


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <blockquote>
<p>Move stones, not mountains.</p>
</blockquote>
<p>Google 官方的 <a href="https://github.com/googlesamples/android-architecture" target="_blank" rel="noopener">Android Architecture Blueprints</a> 推出了 v2 版本，相比于之前的 v1 版本，v2 采取了更先进的设计思想与组件：</p>
<ul>
<li>采用 Kotlin Coroutines 处理后台操作</li>
<li>单一 Activity 结构，用 <a href="https://developer.android.com/guide/navigation/navigation-getting-started" target="_blank" rel="noopener">Navigation component</a> 处理Fragment 之间跳转</li>
<li>由 Fragment(View) 和 ViewModel 组成的 Presentation 层，即 <strong>MVVM</strong> 模式</li>
<li>基于 LiveData 和 DataBinding 的响应式（Reactive）UI</li>
<li>data 层使用一个 Repository 和两个 Datasource（本地数据、远端数据），采用直观的调用方式（非回调、非 data stream）</li>
<li>两个 product flavor，分别是<code>mock</code>和<code>prod</code>，对应着测试与开发环境</li>
<li>一系列单元测试、集成测试以及端到端测试</li>
</ul>
<p>接下来从源码角度解析 master 分支工程，看看 v2 究竟可以为我们带来什么便利。</p>
<hr>
<h2 id="程序入口"><a href="#程序入口" class="headerlink" title="程序入口"></a>程序入口</h2><p>入口在<code>TasksActivity.java</code>，注意到这是一个“SPA”，即 Single Page Application，在<code>AndroidManifest.xml</code>中只声明了这一个 Activity。<code>TasksActivity</code>实际上只是一个壳页面，只处理了 Navigation、ActionBar、NavigationDrawer 等基础功能。它在<code>onCreate</code>里进行这些初始化：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> drawerLayout: DrawerLayout</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> appBarConfiguration: AppBarConfiguration</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    setContentView(R.layout.tasks_act)</span><br><span class="line">    setupNavigationDrawer()</span><br><span class="line">    setSupportActionBar(findViewById(R.id.toolbar))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> navController: NavController = findNavController(R.id.nav_host_fragment)</span><br><span class="line">    appBarConfiguration =</span><br><span class="line">        AppBarConfiguration.Builder(R.id.tasks_fragment_dest, R.id.statistics_fragment_dest)</span><br><span class="line">            .setDrawerLayout(drawerLayout)</span><br><span class="line">            .build()</span><br><span class="line">    setupActionBarWithNavController(navController, appBarConfiguration)</span><br><span class="line">    findViewById&lt;NavigationView&gt;(R.id.nav_view)</span><br><span class="line">        .setupWithNavController(navController)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该应用采用 Navigation component 管理页面跳转，跳转关系在<code>nav_graph.xml</code>文件中以可视化的方式呈现。我们这里不需要关心跳转组件的具体用法， 只要知道它可以启动我们要分析的<code>TasksFragment</code>就可以了。</p>
<h2 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h2><p>我习惯从数据开始分析代码走向，看一下<code>data</code>目录的结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">λ tree data</span><br><span class="line">data</span><br><span class="line">|-- Result.kt</span><br><span class="line">|-- Task.kt</span><br><span class="line">`-- <span class="built_in">source</span></span><br><span class="line">    |-- DefaultTasksRepository.kt</span><br><span class="line">    |-- TasksDataSource.kt</span><br><span class="line">    |-- TasksRepository.kt</span><br><span class="line">    `-- <span class="built_in">local</span></span><br><span class="line">        |-- TasksDao.kt</span><br><span class="line">        |-- TasksLocalDataSource.kt</span><br><span class="line">        `-- ToDoDatabase.kt</span><br></pre></td></tr></table></figure>
<h3 id="Result-kt-与-Task-kt"><a href="#Result-kt-与-Task-kt" class="headerlink" title="Result.kt 与 Task.kt"></a>Result.kt 与 Task.kt</h3><p><code>Result.kt</code>是一个数据请求的结果封装类，业务层对数据的请求均是通过 Result 对象进行封装。这个类使用到了多个 Kotlin 特性，容我在注释里一一说明。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">sealed</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span>&lt;<span class="type">out R</span>&gt; </span>&#123; <span class="comment">// 密封类，将继承限制在类内部；out 类型，协变，保留子类型化关系</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Success</span>&lt;<span class="type">out T</span>&gt;</span>(<span class="keyword">val</span> <span class="keyword">data</span>: T) : Result&lt;T&gt;() <span class="comment">// data 类，协变类型T可以用作构造参数</span></span><br><span class="line">    <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Error</span></span>(<span class="keyword">val</span> exception: Exception) : Result&lt;<span class="built_in">Nothing</span>&gt;() <span class="comment">// Nothing类型，永不返回</span></span><br><span class="line">    <span class="keyword">object</span> Loading : Result&lt;<span class="built_in">Nothing</span>&gt;() <span class="comment">// object直接创建对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">is</span> Success&lt;*&gt; -&gt; <span class="string">"Success[data=<span class="variable">$data</span>]"</span> <span class="comment">// *表示不关心具体类型</span></span><br><span class="line">            <span class="keyword">is</span> Error -&gt; <span class="string">"Error[exception=<span class="variable">$exception</span>]"</span></span><br><span class="line">            Loading -&gt; <span class="string">"Loading"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * `true` if [Result] is of type [Success] &amp; holds non-null [Success.data].</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">val</span> Result&lt;*&gt;.succeeded <span class="comment">// 扩展属性，注意命名不是isSuccess（Chinglish）</span></span><br><span class="line">  <span class="keyword">get</span>() = <span class="keyword">this</span> <span class="keyword">is</span> Success &amp;&amp; <span class="keyword">data</span> != <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p><code>Task.kt</code>描述了任务对象，由<code>title</code>、<code>description</code>、<code>completed</code>和<code>id</code>四个字段构成，同时借助 Room 组件自动关联到名为<strong>tasks</strong>的数据表。</p>
<h3 id="数据接口：TasksDataSource-kt-与-TasksRepository-kt"><a href="#数据接口：TasksDataSource-kt-与-TasksRepository-kt" class="headerlink" title="数据接口：TasksDataSource.kt 与 TasksRepository.kt"></a>数据接口：TasksDataSource.kt 与 TasksRepository.kt</h3><p><code>TasksDataSource.kt</code>和<code>TasksRepository.kt</code>是两个接口类，内容十分相似：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TasksDataSource.kt</span></span><br><span class="line"><span class="comment">// Main entry point for accessing tasks data.</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TasksDataSource</span> </span>&#123;</span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">getTasks</span><span class="params">()</span></span>: Result&lt;List&lt;Task&gt;&gt;</span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">getTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span>: Result&lt;Task&gt;</span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">saveTask</span><span class="params">(task: <span class="type">Task</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">completeTask</span><span class="params">(task: <span class="type">Task</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">completeTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">activateTask</span><span class="params">(task: <span class="type">Task</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">activateTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">clearCompletedTasks</span><span class="params">()</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">deleteAllTasks</span><span class="params">()</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">deleteTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TasksRepository.kt</span></span><br><span class="line"><span class="comment">// Interface to the data layer.</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TasksRepository</span> </span>&#123;</span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">getTasks</span><span class="params">(forceUpdate: <span class="type">Boolean</span> = <span class="literal">false</span>)</span></span>: Result&lt;List&lt;Task&gt;&gt;</span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">getTask</span><span class="params">(taskId: <span class="type">String</span>, forceUpdate: <span class="type">Boolean</span> = <span class="literal">false</span>)</span></span>: Result&lt;Task&gt;</span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">saveTask</span><span class="params">(task: <span class="type">Task</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">completeTask</span><span class="params">(task: <span class="type">Task</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">completeTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">activateTask</span><span class="params">(task: <span class="type">Task</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">activateTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">clearCompletedTasks</span><span class="params">()</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">deleteAllTasks</span><span class="params">()</span></span></span><br><span class="line">    suspend <span class="function"><span class="keyword">fun</span> <span class="title">deleteTask</span><span class="params">(taskId: <span class="type">String</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到两者的方法几乎是一样的：名字和数量相同，区别仅仅在于<code>TasksRepository</code>中的个别方法多了<code>forceUpdate</code>参数。不过，这两个接口在语义上是不同的。</p>
<ul>
<li><code>TasksDatasource</code>是底层数据封装，数据可能来自网络，也可能来自于文件、数据库。</li>
<li><code>TasksRepository</code>是数据层对外的接口，业务代码通过该接口对数据进行增删改查。<code>forceUpdate</code>参数作用于接口实现类内部的缓存。</li>
<li><code>suspend</code>关键字说明它们均为 Coroutines 接口。</li>
</ul>
<p>然后我们来看下对外的接口是如何给到使用者的。<code>TodoApplication</code>类继承自<code>Application</code>，其中有一个成员变量<code>taskRepository</code>。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TodoApplication.kt</span></span><br><span class="line"><span class="keyword">val</span> taskRepository: TasksRepository</span><br><span class="line">    <span class="keyword">get</span>() = ServiceLocator.provideTasksRepository(<span class="keyword">this</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment">// ServiceLocator.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">provideTasksRepository</span><span class="params">(context: <span class="type">Context</span>)</span></span>: TasksRepository &#123;</span><br><span class="line">    synchronized(<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> tasksRepository ?: tasksRepository ?: createTasksRepository(context)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createTasksRepository</span><span class="params">(context: <span class="type">Context</span>)</span></span>: TasksRepository &#123;</span><br><span class="line">    <span class="keyword">return</span> DefaultTasksRepository(FakeTasksRemoteDataSource, createTaskLocalDataSource(context))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// TodoApplication.taskRepository 通过 Fragment 的扩展方法给到各个 Fragment</span></span><br><span class="line"><span class="comment">// FragmentExt.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Fragment.<span class="title">getViewModelFactory</span><span class="params">()</span></span>: ViewModelFactory &#123;</span><br><span class="line">  <span class="keyword">val</span> repository = (requireContext().applicationContext <span class="keyword">as</span> TodoApplication).taskRepository</span><br><span class="line">  <span class="keyword">return</span> ViewModelFactory(repository)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="local-目录：本地数据实现"><a href="#local-目录：本地数据实现" class="headerlink" title="local 目录：本地数据实现"></a>local 目录：本地数据实现</h3><p>local 目录下是<code>TasksDatasource</code>的本地实现，与此相对的，若数据来源于网络，则还应当有一个 remote 目录。</p>
<ul>
<li><code>ToDoDatabase</code> 是数据库声明</li>
<li><code>TasksDao</code> 声明 tasks 表的 CRUD 操作</li>
<li><code>TasksLocalDataSource</code> 是<code>TasksDataSource</code>的本地实现，使用<code>Dispatchers.IO</code>作为协程上下文，调用<code>TasksDao</code>完成数据操作</li>
</ul>
<h3 id="数据层总结"><a href="#数据层总结" class="headerlink" title="数据层总结"></a>数据层总结</h3><p>相比于曾经分析过的<strong>todo-mvp</strong>和<strong>todo-mvp-clean</strong>，最直观的感受是，v2在保证数据接口语义不变的前提下，借助 Coroutines 简化了原有的回调写法，用同步的方式写异步的代码。此外，像使用 Room 做 ORM、local/remote 两套数据实现等，与之前的项目并无不同。</p>
<hr>
<h2 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h2><h3 id="背景知识：ViewModel-与-LiveData"><a href="#背景知识：ViewModel-与-LiveData" class="headerlink" title="背景知识：ViewModel 与 LiveData"></a>背景知识：ViewModel 与 LiveData</h3><p>ViewModel 与 LiveData 都是 Android Jetpack 中的架构组件，它们通常组合使用，达到将数据和视图解耦的目的。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/img/191011_architecture_master_v2/jetpack.png" alt="jetpack" title="">
                </div>
                <div class="image-caption">jetpack</div>
            </figure>
<p><strong>ViewModel</strong></p>
<ul>
<li>避免屏幕旋转等事件发生时，保存在 Activity 中的数据被销毁并重建</li>
<li>异步回调时防止内存泄漏、Context 为 Null</li>
<li>将数据和视图解耦，防止出现 God Activities 和 God Fragments</li>
</ul>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="/img/191011_architecture_master_v2/viewmodel.png" alt="viewmodel" title="">
                </div>
                <div class="image-caption">viewmodel</div>
            </figure>
<p><strong>LiveData</strong></p>
<ul>
<li>DataBinding 思想的一种实现，数据/视图双向绑定</li>
<li>与生命周期关联，页面销毁后自动将其从订阅者列表去除</li>
</ul>
<h3 id="ViewModelFactory"><a href="#ViewModelFactory" class="headerlink" title="ViewModelFactory"></a>ViewModelFactory</h3><p>ViewModel 的创建采用工厂模式进行统一管理。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewModelFactory.kt</span></span><br><span class="line"><span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewModelFactory</span> <span class="keyword">constructor</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> tasksRepository: TasksRepository</span><br><span class="line">) : ViewModelProvider.NewInstanceFactory() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">create</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span> =</span><br><span class="line">        with(modelClass) &#123;</span><br><span class="line">          <span class="keyword">when</span> &#123;</span><br><span class="line">                isAssignableFrom(StatisticsViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>) -&gt;</span></span><br><span class="line">                    StatisticsViewModel(tasksRepository)</span><br><span class="line">                isAssignableFrom(TaskDetailViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>) -&gt;</span></span><br><span class="line">                    TaskDetailViewModel(tasksRepository)</span><br><span class="line">                isAssignableFrom(AddEditTaskViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>) -&gt;</span></span><br><span class="line">                    AddEditTaskViewModel(tasksRepository)</span><br><span class="line">                isAssignableFrom(TasksViewModel::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>) -&gt;</span></span><br><span class="line">                    TasksViewModel(tasksRepository)</span><br><span class="line">                <span class="keyword">else</span> -&gt;</span><br><span class="line">                    <span class="keyword">throw</span> IllegalArgumentException(<span class="string">"Unknown ViewModel class: <span class="subst">$&#123;modelClass.name&#125;</span>"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">as</span> T</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还记得上文提到过为 Fragment 增加的扩展函数吗？在每一个页面（Fragment）里通过这个扩展函数获取到工厂类，进而获得对应 ViewModel 类的实例。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FragmentExt.kt</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> Fragment.<span class="title">getViewModelFactory</span><span class="params">()</span></span>: ViewModelFactory &#123;</span><br><span class="line">  <span class="keyword">val</span> repository = (requireContext().applicationContext <span class="keyword">as</span> TodoApplication).taskRepository</span><br><span class="line">  <span class="keyword">return</span> ViewModelFactory(repository)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TasksFragment.kt</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasksFragment</span> : <span class="type">Fragment</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel <span class="keyword">by</span> viewModels&lt;TasksViewModel&gt; &#123; getViewModelFactory() &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是 ViewModel 类，它承担了与 Presenter 类似的职责，是处理业务逻辑的地方。如果需要的话，可以增加一个 Domain 层，负责提取出来的业务逻辑（Use cases），提供复用，这样就变成了 <a href="https://github.com/googlesamples/android-architecture/tree/usecases" target="_blank" rel="noopener">MVVM-Clean</a> 模式。在 master 分支上还没有 domain 层。</p>
<h3 id="TasksViewModel"><a href="#TasksViewModel" class="headerlink" title="TasksViewModel"></a>TasksViewModel</h3><p>ViewModel 接受一个 TasksRepository 参数，用作数据层接口。（在clean架构里，这里传入的不是Repository，而是UseCases）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasksViewModel</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> tasksRepository: TasksRepository</span><br><span class="line">) : ViewModel() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随后声明了一系列变量作为页面数据&amp;状态，这里采用“一个对象，两个变量”的成对写法，略显繁琐，不知道有没有更优美的处理方法。这样做的目的是把对变量的修改关闭，对外（即LiveData）仅提供读取变量的接口，只可以在 ViewModel 内部修改变量。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _items = MutableLiveData&lt;List&lt;Task&gt;&gt;().apply &#123; value = emptyList() &#125; <span class="comment">// 以下划线开头的为私有变量，apply 和 with 的用法要分清，相当于调用 _items.setValue(emptyList()); return _items;</span></span><br><span class="line"><span class="keyword">val</span> items: LiveData&lt;List&lt;Task&gt;&gt; = _items</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _dataLoading = MutableLiveData&lt;<span class="built_in">Boolean</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> dataLoading: LiveData&lt;<span class="built_in">Boolean</span>&gt; = _dataLoading</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _currentFilteringLabel = MutableLiveData&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> currentFilteringLabel: LiveData&lt;<span class="built_in">Int</span>&gt; = _currentFilteringLabel</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _noTasksLabel = MutableLiveData&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> noTasksLabel: LiveData&lt;<span class="built_in">Int</span>&gt; = _noTasksLabel</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _noTaskIconRes = MutableLiveData&lt;<span class="built_in">Int</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> noTaskIconRes: LiveData&lt;<span class="built_in">Int</span>&gt; = _noTaskIconRes</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _tasksAddViewVisible = MutableLiveData&lt;<span class="built_in">Boolean</span>&gt;()</span><br><span class="line"><span class="keyword">val</span> tasksAddViewVisible: LiveData&lt;<span class="built_in">Boolean</span>&gt; = _tasksAddViewVisible</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _snackbarText = MutableLiveData&lt;Event&lt;<span class="built_in">Int</span>&gt;&gt;()</span><br><span class="line"><span class="keyword">val</span> snackbarText: LiveData&lt;Event&lt;<span class="built_in">Int</span>&gt;&gt; = _snackbarText</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _currentFiltering = TasksFilterType.ALL_TASKS   <span class="comment">// Not used at the moment private val isDataLoadingError = MutableLiveData&lt;Boolean&gt;()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _openTaskEvent = MutableLiveData&lt;Event&lt;String&gt;&gt;()</span><br><span class="line"><span class="keyword">val</span> openTaskEvent: LiveData&lt;Event&lt;String&gt;&gt; = _openTaskEvent</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> _newTaskEvent = MutableLiveData&lt;Event&lt;<span class="built_in">Unit</span>&gt;&gt;()</span><br><span class="line"><span class="keyword">val</span> newTaskEvent: LiveData&lt;Event&lt;<span class="built_in">Unit</span>&gt;&gt; = _newTaskEvent</span><br><span class="line"></span><br><span class="line"><span class="comment">// This LiveData depends on another so we can use a transformation.</span></span><br><span class="line"><span class="keyword">val</span> empty: LiveData&lt;<span class="built_in">Boolean</span>&gt; = Transformations.map(_items) &#123;</span><br><span class="line"> it.isEmpty()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以说管理上面这些数据是 ViewModel 最主要的职责了，从功能上区分，这些数据可以分成<strong>3种</strong>。</p>
<ol>
<li>业务实体如 items（任务对象列表），ViewModel 通过修改这类对象，借助于 DataBinding 更新 UI</li>
<li>数据状态对象如 dataLoading（是否正在加载数据）、currentFilteringLabel（当前的过滤器文字）、noTasksLabel（没有任务的文字）、snackbarText（提示栏文字），这一类对象不进行持久化存储，但是也会影响到 UI 显示</li>
<li>事件包装对象如 openTaskEvent（打开某个任务，在点击列表中的任务时触发）、newTaskEvent（创建一个任务，在点击+时触发），它们负责通知页面进行跳转——这部分设计得不佳，为了 DataBinding 而强行 DataBinding</li>
</ol>
<p>总之贯彻的思想是：一切变动都是数据变动，数据变动通过 DataBinding 自动投射到 UI。</p>
<hr>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>视图也就是<code>TasksFragment.kt</code>类，负责初始化布局，触发 ViewModel 进行首次加载。这里的 Fragment 继承自 androidx 中的 Fragment。</p>
<p>在<code>onCreateView</code>里初始化 DataBinding（数据）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    inflater: <span class="type">LayoutInflater</span>, container: <span class="type">ViewGroup</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">  savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>: View? &#123;</span><br><span class="line">    viewDataBinding = TasksFragBinding.inflate(inflater, container, <span class="literal">false</span>).apply &#123;</span><br><span class="line">    viewmodel = viewModel</span><br><span class="line">    &#125;</span><br><span class="line">  setHasOptionsMenu(<span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">return</span> viewDataBinding.root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>onActivityCreated</code>里初始化 UI（视图），初始化完成后启动加载（代码最后一行）。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityCreated</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onActivityCreated(savedInstanceState)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the lifecycle owner to the lifecycle of the view</span></span><br><span class="line">    viewDataBinding.lifecycleOwner = <span class="keyword">this</span>.viewLifecycleOwner</span><br><span class="line">    setupSnackbar()</span><br><span class="line">    setupListAdapter()</span><br><span class="line">    setupRefreshLayout(viewDataBinding.refreshLayout, viewDataBinding.tasksList)</span><br><span class="line">    setupNavigation()</span><br><span class="line">    setupFab()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always reloading data for simplicity. Real apps should only do this on first load and</span></span><br><span class="line">    <span class="comment">// when navigating back to this destination. <span class="doctag">TODO:</span> https://issuetracker.google.com/79672220</span></span><br><span class="line">    viewModel.loadTasks(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此外，Fragment 中还会进行设置 OnClickListener、Adapter 等操作，比较简单，不赘述。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>v2 的项目设计时采取了 MVVM 思想，旨在解决 MVP 模式下Presenter 层过于庞大的问题。其实 MVP-Clean 模式已经对此有一些缓解。而 MVVM 做的更彻底，干脆把数据对 UI 的控制完全交给框架自动进行。这样做的好处显而易见，但也并不是没有缺点，比如一旦出了问题，如果没有掌握个中原理，调试时必定摸不清头绪。总而言之，这是一个值得学习与尝试的架构设计。</p>
<hr>
<h2 id="Bonus：usecases"><a href="#Bonus：usecases" class="headerlink" title="Bonus：usecases"></a>Bonus：usecases</h2><p><a href="https://github.com/googlesamples/android-architecture/tree/usecases" target="_blank" rel="noopener">usecases</a> 是 v2 中的一个 Stable<br> 分支（另一个是<a href="https://github.com/googlesamples/android-architecture/tree/dagger-android" target="_blank" rel="noopener">dagger-android</a>)。usecases 以解耦、抽象、单向依赖为核心设计理念，这也是 Clean 架构的核心思想。</p>
<ul>
<li>表现层只能访问到领域层/用例层，不知道数据层的存在</li>
<li>领域层/用例层只能访问到数据层，无法访问表现层</li>
<li>数据层无法访问表现层和领域层</li>
</ul>
<p>领域层（或者叫用例层），即 Domain Layer，是由多个 UseCase 组成的，每一个 UseCase 对应一个业务逻辑。以“加载单个Task”为例，可以看到 UseCase 里直接将请求转发给 TasksRepository 来处理，逻辑十分简单。</p>
<p>在分析具体差别之前，可以先看一遍 usecase 分支与 master 分支的 diff：<a href="https://github.com/googlesamples/android-architecture/compare/usecases#files_bucket" target="_blank" rel="noopener">https://github.com/googlesamples/android-architecture/compare/usecases#files_bucket</a></p>
<p><strong>GetTaskUseCase.kt</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetTaskUseCase</span></span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> tasksRepository: TasksRepository</span><br><span class="line">  ) &#123;</span><br><span class="line">    suspend <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(taskId: <span class="type">String</span>, forceUpdate: <span class="type">Boolean</span> = <span class="literal">false</span>)</span></span>: Result&lt;Task&gt; &#123;</span><br><span class="line">    wrapEspressoIdlingResource &#123;</span><br><span class="line">      <span class="keyword">return</span> tasksRepository.getTask(taskId, forceUpdate)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而获取 Tasks 列表的 Usecase 相对复杂一些，包括了原本在 TasksViewModel 中处理的过滤逻辑，从另一个角度看，这相当于减轻了 ViewModel 的负担。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetTasksUseCase</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> tasksRepository: TasksRepository</span><br><span class="line">) &#123;</span><br><span class="line">    suspend <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">invoke</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        forceUpdate: <span class="type">Boolean</span> = <span class="literal">false</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        currentFiltering: <span class="type">TasksFilterType</span> = ALL_TASKS</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span>: Result&lt;List&lt;Task&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">        wrapEspressoIdlingResource &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> tasksResult = tasksRepository.getTasks(forceUpdate)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Filter tasks</span></span><br><span class="line">            <span class="keyword">if</span> (tasksResult <span class="keyword">is</span> Success &amp;&amp; currentFiltering != ALL_TASKS) &#123;</span><br><span class="line">                <span class="keyword">val</span> tasks = tasksResult.<span class="keyword">data</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> tasksToShow = mutableListOf&lt;Task&gt;()</span><br><span class="line">                <span class="comment">// We filter the tasks based on the requestType</span></span><br><span class="line">                <span class="keyword">for</span> (task <span class="keyword">in</span> tasks) &#123;</span><br><span class="line">                    <span class="keyword">when</span> (currentFiltering) &#123;</span><br><span class="line">                        ACTIVE_TASKS -&gt; <span class="keyword">if</span> (task.isActive) &#123;</span><br><span class="line">                            tasksToShow.add(task)</span><br><span class="line">                        &#125;</span><br><span class="line">                        COMPLETED_TASKS -&gt; <span class="keyword">if</span> (task.isCompleted) &#123;</span><br><span class="line">                            tasksToShow.add(task)</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> -&gt; NotImplementedError()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> Success(tasksToShow)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> tasksResult</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于 ViewModel 里，将原来的 Repository 参数改为当前 ViewModel 用到的 UseCase 参数即可，所有处理数据的请求都有 UseCase 来接管。</p>
<p><strong>TasksViewModel.kt</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasksViewModel</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> getTasksUseCase: GetTasksUseCase,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> clearCompletedTasksUseCase: ClearCompletedTasksUseCase,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> completeTaskUseCase: CompleteTaskUseCase,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> activateTaskUseCase: ActivateTaskUseCase</span><br><span class="line">) : ViewModel() &#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Over~</p>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-10-11T15:54:24.831Z" itemprop="dateUpdated">2019-10-11 23:54:24</time>
</span><br>


        
        本文系作者原创，如转载请注明出处。欢迎留言讨论，或通过邮件进行沟通～
        
    </div>
    
    <footer>
        <a href="https://lilei.pro">
            <img src="/img/avatar.jpeg" alt="Li Lei">
            Li Lei
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/架构/">架构</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://lilei.pro/2019/10/11/architecture-master-v2/&title=《架构学习之 master-v2》 — 柘个角落&pic=https://lilei.pro/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://lilei.pro/2019/10/11/architecture-master-v2/&title=《架构学习之 master-v2》 — 柘个角落&source=技术与生活上的点滴积累" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://lilei.pro/2019/10/11/architecture-master-v2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《架构学习之 master-v2》 — 柘个角落&url=https://lilei.pro/2019/10/11/architecture-master-v2/&via=https://lilei.pro" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://lilei.pro/2019/10/11/architecture-master-v2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2019/10/11/flash-boys/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Flash Boys 读书笔记</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2019/08/27/jcip-errata/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">《Java 并发编程实战》勘误表 2019-08-27</h4>
      </a>
    </div>
  
</nav>



    











    <!-- Valine Comments -->
    <div class="comments vcomment" id="comments"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <!-- Valine Comments script -->
    <script>
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
          return GUEST_INFO.indexOf(item) > -1
        });
        new Valine({
            el: '#comments',
            notify: 'false' == 'true',
            verify: 'true' == 'true',
            appId: "khG3rBt0nWda7lxDUHpS3Sq0-gzGzoHsz",
            appKey: "btFkQfcBgJeCRm55mYmUgA5d",
            avatar: "mm",
            placeholder: "欢迎讨论",
            guest_info: guest_info.length == 0 ? GUEST_INFO : guest_info,
            pageSize: "10"
        })
    </script>
    <!-- Valine Comments end -->







</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>Li Lei &copy; 2015 - 2020</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://lilei.pro/2019/10/11/architecture-master-v2/&title=《架构学习之 master-v2》 — 柘个角落&pic=https://lilei.pro/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://lilei.pro/2019/10/11/architecture-master-v2/&title=《架构学习之 master-v2》 — 柘个角落&source=技术与生活上的点滴积累" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://lilei.pro/2019/10/11/architecture-master-v2/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《架构学习之 master-v2》 — 柘个角落&url=https://lilei.pro/2019/10/11/architecture-master-v2/&via=https://lilei.pro" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://lilei.pro/2019/10/11/architecture-master-v2/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3awW7rMAwEwP7/T6dAr038din3AZZGpyBwZI8PDEnx6yter591/f3vz59Wvs/NCwMD47GM5Ja/t/70zafHbcH168DAwDiAMQumyetIdr6+V/QHgIGBgTF69ASWkzAwMDDawrJFtgkiBgYGxqyIvTe85gH35locAwPjgYz2YOB/fv7D8w0MDIyHMF4L6+/2rH+FgYGxNeO6BM0fNA+USeHatt4wMDBOYMwKyOvr83ZeWwb/49VjYGBsx5jdID88iBr6cTOu3hQDA2MLRt6sv+vKdvCieK0YGBgHMNqfrR8o5piobMbAwNiUcVfjfqV9Ntt56XwDAwPjgYx82DQpa9skcha+MTAwzmGsBMQ2yOYp4Kwxh4GBsStjNmbRBtw8+WuHPN5kuBgYGAcwkkPEWXBsxziKgwcMDIytGStBMH8Fbbk7HMLAwMDYmjF70PY44YZxiqTdhoGBsR3jriI2uVmSYrZzIhgYGCcwZseNbVs/j/35QeabazAwMI5htM36lSvb8Y56awwMjO0Ys/RupUG2nhQWIxcYGBgPZ6ykZbObJY25WVzFwMDYj/Eq1yzIXoPb79/cEQMDY2tGvvIw2taVs6K6LnExMDAezkiCbDsulofUWZKKgYFxJqMNfCvTZ+vl68dGGwYGBkaZSs7C9DCfxcDAwIjTx9nRQvLiMDAwMPJHvHeoYiVZxMDAOIcxOxhoH70NtfeOaGBgYDyW8Q0+ZYmHbHZkKQAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>










</body>
</html>
